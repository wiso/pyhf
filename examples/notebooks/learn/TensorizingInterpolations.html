

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tensorizing Interpolators &mdash; pyhf 0.0.4 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.2/gh-fork-ribbon.min.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> pyhf
          

          
          </a>

          
            
            
              <div class="version">
                0.0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../talks.html">Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Developing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyhf</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>Tensorizing Interpolators</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/examples/notebooks/learn/TensorizingInterpolations.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Tensorizing-Interpolators">
<h1>Tensorizing Interpolators<a class="headerlink" href="#Tensorizing-Interpolators" title="Permalink to this headline">¶</a></h1>
<p>This notebook will introduce some tensor algebra concepts about being
able to convert from calculations inside for-loops into a single
calculation over the entire tensor. It is assumed that you have some
familiarity with what interpolation functions are used for in <code class="docutils literal notranslate"><span class="pre">pyhf</span></code>.</p>
<p>To get started, we’ll load up some functions we wrote whose job is to
generate sets of histograms and alphas that we will compute
interpolations for. This allows us to generate random, structured input
data that we can use to test the tensorized form of the interpolation
function against the original one we wrote. For now, we will consider
only the <code class="docutils literal notranslate"><span class="pre">numpy</span></code> backend for simplicity, but can replace <code class="docutils literal notranslate"><span class="pre">np</span></code> to
<code class="docutils literal notranslate"><span class="pre">pyhf.tensorlib</span></code> to achieve identical functionality.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">random_histosets_alphasets_pair</span></code> will produce a pair
<code class="docutils literal notranslate"><span class="pre">(histogramsets,</span> <span class="pre">alphasets)</span></code> of histograms and alphas for those
histograms that represents the type of input we wish to interpolate on.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">random_histosets_alphasets_pair</span><span class="p">(</span><span class="n">nsysts</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span> <span class="n">nhistos_per_syst_upto</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="n">nalphas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbins_upto</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">generate_shapes</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
        <span class="n">h_shape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a_shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alphasets</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span><span class="n">alphasets</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">hs</span> <span class="ow">in</span> <span class="n">histogramssets</span><span class="p">:</span>
            <span class="n">h_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">hs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hs</span><span class="p">:</span>
                <span class="n">h_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">sh</span> <span class="ow">in</span> <span class="n">h</span><span class="p">:</span>
                    <span class="n">h_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">sh</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">h_shape</span><span class="p">),</span><span class="n">a_shape</span>

    <span class="k">def</span> <span class="nf">filled_shapes</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
        <span class="c1"># pad our shapes with NaNs</span>
        <span class="n">histos</span><span class="p">,</span> <span class="n">alphas</span> <span class="o">=</span> <span class="n">generate_shapes</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">)</span>
        <span class="n">histos</span><span class="p">,</span> <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">histos</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">syst</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">syst</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">variation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
                    <span class="n">histos</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,:</span><span class="nb">len</span><span class="p">(</span><span class="n">variation</span><span class="p">)]</span> <span class="o">=</span> <span class="n">variation</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">alphaset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alphasets</span><span class="p">):</span>
            <span class="n">alphas</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="nb">len</span><span class="p">(</span><span class="n">alphaset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">alphaset</span>
        <span class="k">return</span> <span class="n">histos</span><span class="p">,</span><span class="n">alphas</span>

    <span class="n">nsyst_histos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">nhistos_per_syst_upto</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nsysts</span><span class="p">)</span>
    <span class="n">nhistograms</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nbins_upto</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nsyst_histos</span><span class="p">]</span>
    <span class="n">random_alphas</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">nalphas</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nsyst_histos</span><span class="p">]</span>

    <span class="n">random_histogramssets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="c1"># all histos affected by systematic $nh</span>
            <span class="p">[</span><span class="c1"># sample $i, systematic $nh</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">,</span><span class="mi">10</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">nbin</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">nbin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nh</span><span class="p">)</span>
        <span class="p">]</span> <span class="k">for</span> <span class="n">nh</span> <span class="ow">in</span> <span class="n">nhistograms</span>
    <span class="p">]</span>
    <span class="n">h</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">filled_shapes</span><span class="p">(</span><span class="n">random_histogramssets</span><span class="p">,</span><span class="n">random_alphas</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">,</span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="section" id="The-(slow)-interpolations">
<h2>The (slow) interpolations<a class="headerlink" href="#The-(slow)-interpolations" title="Permalink to this headline">¶</a></h2>
<p>In all cases, the way we do interpolations is as follows:</p>
<ol class="arabic simple">
<li>Loop over both the <code class="docutils literal notranslate"><span class="pre">histogramssets</span></code> and <code class="docutils literal notranslate"><span class="pre">alphasets</span></code>
simultaneously (e.g. using python’s <code class="docutils literal notranslate"><span class="pre">zip()</span></code>)</li>
<li>Loop over all histograms set in the set of histograms sets that
correspond to the histograms affected by a given systematic</li>
<li>Loop over all of the alphas in the set of alphas</li>
<li>Loop over all the bins in the histogram sets simultaneously (e.g.
using python’s <code class="docutils literal notranslate"><span class="pre">zip()</span></code>)</li>
<li>Apply the interpolation across the same bin index</li>
</ol>
<p>This is already exhausting to think about, so let’s put this in code
form. Depending on the kind of interpolation being done, we’ll pass in
<code class="docutils literal notranslate"><span class="pre">func</span></code> as an argument to the top-level interpolation loop to switch
between linear (<code class="docutils literal notranslate"><span class="pre">interpcode=0</span></code>) and non-linear (<code class="docutils literal notranslate"><span class="pre">interpcode=1</span></code>).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">interpolation_looper</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span> <span class="n">alphasets</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span> <span class="n">alphasets</span><span class="p">):</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="n">all_results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">histo</span> <span class="ow">in</span> <span class="n">histoset</span><span class="p">:</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">histo_result</span> <span class="o">=</span> <span class="n">set_result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphaset</span><span class="p">:</span>
                <span class="n">alpha_result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">down</span><span class="p">,</span><span class="n">nom</span><span class="p">,</span><span class="n">up</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">histo</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">down</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
                    <span class="n">alpha_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">histo_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>
</pre></div>
</div>
</div>
<p>And we can also define our linear and non-linear interpolations we’ll
consider in this notebook that we wish to tensorize.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">interpolation_linear</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">summand</span><span class="p">(</span><span class="n">down</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="n">delta_up</span> <span class="o">=</span> <span class="n">up</span> <span class="o">-</span> <span class="n">nom</span>
        <span class="n">delta_down</span> <span class="o">=</span> <span class="n">nom</span> <span class="o">-</span> <span class="n">down</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span>  <span class="n">delta_up</span><span class="o">*</span><span class="n">alpha</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span>  <span class="n">delta_down</span><span class="o">*</span><span class="n">alpha</span>
        <span class="k">return</span> <span class="n">nom</span> <span class="o">+</span> <span class="n">delta</span>
    <span class="k">return</span> <span class="n">interpolation_looper</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span> <span class="n">alphasets</span><span class="p">,</span> <span class="n">summand</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">interpolation_nonlinear</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">product</span><span class="p">(</span><span class="n">down</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="n">delta_up</span> <span class="o">=</span> <span class="n">up</span><span class="o">/</span><span class="n">nom</span>
        <span class="n">delta_down</span> <span class="o">=</span> <span class="n">down</span><span class="o">/</span><span class="n">nom</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span>  <span class="n">delta_up</span><span class="o">**</span><span class="n">alpha</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span>  <span class="n">delta_down</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nom</span><span class="o">*</span><span class="n">delta</span>
    <span class="k">return</span> <span class="n">interpolation_looper</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span> <span class="n">alphasets</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We will also define a helper function that allows us to pass in two
functions we wish to compare the outputs for:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">compare_fns</span><span class="p">(</span><span class="n">func1</span><span class="p">,</span> <span class="n">func2</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">random_histosets_alphasets_pair</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_func_runner</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">histssets</span><span class="p">,</span> <span class="n">alphasets</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">histssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">))</span>

    <span class="n">old</span> <span class="o">=</span> <span class="n">_func_runner</span><span class="p">(</span><span class="n">func1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">_func_runner</span><span class="p">(</span><span class="n">func2</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">old</span><span class="p">)]</span> <span class="o">==</span> <span class="n">new</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">new</span><span class="p">)]),</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>For the rest of the notebook, we will detail in explicit form how the
linear interpolator gets tensorized, step-by-step. The same sequence of
steps will be shown for the non-linear interpolator – but it is left up
to the reader to understand the steps.</p>
<div class="section" id="Tensorizing-the-Linear-Interpolator">
<h3>Tensorizing the Linear Interpolator<a class="headerlink" href="#Tensorizing-the-Linear-Interpolator" title="Permalink to this headline">¶</a></h3>
<div class="section" id="Step-0">
<h4>Step 0<a class="headerlink" href="#Step-0" title="Permalink to this headline">¶</a></h4>
<p>Step 0 requires converting the innermost conditional check on
<code class="docutils literal notranslate"><span class="pre">alpha</span> <span class="pre">&gt;</span> <span class="pre">0</span></code> into something tensorizable. This also means the
calculation itself is going to become tensorized. So we will convert
from</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">delta</span> <span class="o">=</span>  <span class="n">delta_up</span><span class="o">*</span><span class="n">alpha</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">delta</span> <span class="o">=</span>  <span class="n">delta_down</span><span class="o">*</span><span class="n">alpha</span>
</pre></div>
</div>
<p>to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta_up</span><span class="o">*</span><span class="n">alpha</span><span class="p">,</span> <span class="n">delta_down</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s make that change now, and let’s check to make sure we still do the
calculation correctly.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># get the internal calculation to use tensorlib backend</span>
<span class="k">def</span> <span class="nf">new_interpolation_linear_step0</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="n">all_results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">histo</span> <span class="ow">in</span> <span class="n">histoset</span><span class="p">:</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">histo_result</span> <span class="o">=</span> <span class="n">set_result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphaset</span><span class="p">:</span>
                <span class="n">alpha_result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">down</span><span class="p">,</span><span class="n">nom</span><span class="p">,</span><span class="n">up</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">histo</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">delta_up</span> <span class="o">=</span> <span class="n">up</span> <span class="o">-</span> <span class="n">nom</span>
                    <span class="n">delta_down</span> <span class="o">=</span> <span class="n">nom</span> <span class="o">-</span> <span class="n">down</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta_up</span><span class="o">*</span><span class="n">alpha</span><span class="p">,</span> <span class="n">delta_down</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">nom</span> <span class="o">+</span> <span class="n">delta</span>
                    <span class="n">alpha_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">histo_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>
</pre></div>
</div>
</div>
<p>And does the calculation still match?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_linear</span><span class="p">,</span> <span class="n">new_interpolation_linear_step0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_linear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 182 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_linear_step0(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 254 ms per loop
</pre></div></div>
</div>
<p>Great! We’re a little bit slower right now, but that’s expected. We’re
just getting started.</p>
</div>
<div class="section" id="Step-1">
<h4>Step 1<a class="headerlink" href="#Step-1" title="Permalink to this headline">¶</a></h4>
<p>In this step, we would like to remove the innermost <code class="docutils literal notranslate"><span class="pre">zip()</span></code> call over
the histogram bins by calculating the interpolation between the
histograms in one fell swoop. This means, instead of writing something
like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">down</span><span class="p">,</span><span class="n">nom</span><span class="p">,</span><span class="n">up</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">histo</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="n">delta_up</span> <span class="o">=</span> <span class="n">up</span> <span class="o">-</span> <span class="n">nom</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>one can instead write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">delta_up</span> <span class="o">=</span> <span class="n">histo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">...</span>
</pre></div>
</div>
<p>taking advantage of the automatic broadcasting of operations on input
tensors. This sort of feature of the tensor backends allows us to speed
up code, such as interpolation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># update the delta variations to remove the zip() call and remove most-nested loop</span>
<span class="k">def</span> <span class="nf">new_interpolation_linear_step1</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="n">all_results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">histo</span> <span class="ow">in</span> <span class="n">histoset</span><span class="p">:</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">histo_result</span> <span class="o">=</span> <span class="n">set_result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphaset</span><span class="p">:</span>
                <span class="n">alpha_result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">deltas_up</span>    <span class="o">=</span> <span class="n">histo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">deltas_dn</span>    <span class="o">=</span> <span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">calc_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deltas_up</span><span class="o">*</span><span class="n">alpha</span><span class="p">,</span> <span class="n">deltas_dn</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">calc_deltas</span>
                <span class="n">alpha_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">histo_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>
</pre></div>
</div>
</div>
<p>And does the calculation still match?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_linear</span><span class="p">,</span> <span class="n">new_interpolation_linear_step1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_linear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
10 loops, best of 3: 182 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_linear_step1(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 433 ms per loop
</pre></div></div>
</div>
<p>Great!</p>
</div>
<div class="section" id="Step-2">
<h4>Step 2<a class="headerlink" href="#Step-2" title="Permalink to this headline">¶</a></h4>
<p>In this step, we would like to move the giant array of the deltas
calculated to the beginning – outside of all loops – and then only
take a subset of it for the calculation itself. This allows us to figure
out the entire structure of the input for the rest of the calculations
as we slowly move towards including <code class="docutils literal notranslate"><span class="pre">einsum()</span></code> calls (einstein
summation). This means we would like to go from</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">histo</span> <span class="ow">in</span> <span class="n">histoset</span><span class="p">:</span>
    <span class="n">delta_up</span> <span class="o">=</span> <span class="n">histo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">...</span>
</pre></div>
</div>
<p>to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">all_deltas</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">for</span> <span class="n">nh</span><span class="p">,</span> <span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
    <span class="n">deltas</span> <span class="o">=</span> <span class="n">all_deltas</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Again, we are taking advantage of the automatic broadcasting of
operations on input tensors to calculate all the deltas in a single
action.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># figure out the giant array of all deltas at the beginning and only take subsets of it for the calculation</span>
<span class="k">def</span> <span class="nf">new_interpolation_linear_step2</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>

    <span class="n">allset_all_histo_deltas_up</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">allset_all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">nset</span><span class="p">,(</span><span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">)):</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">all_histo_deltas_up</span> <span class="o">=</span> <span class="n">allset_all_histo_deltas_up</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>
        <span class="n">all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">allset_all_histo_deltas_dn</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
            <span class="n">alpha_deltas</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphaset</span><span class="p">:</span>
                <span class="n">alpha_result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">deltas_up</span>    <span class="o">=</span> <span class="n">all_histo_deltas_up</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span>
                <span class="n">deltas_dn</span>    <span class="o">=</span> <span class="n">all_histo_deltas_dn</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span>
                <span class="n">calc_deltas</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deltas_up</span><span class="o">*</span><span class="n">alpha</span><span class="p">,</span> <span class="n">deltas_dn</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span>
                <span class="n">alpha_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_deltas</span><span class="p">)</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">alpha_deltas</span><span class="p">])</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>
</pre></div>
</div>
</div>
<p>And does the calculation still match?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_linear</span><span class="p">,</span> <span class="n">new_interpolation_linear_step2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_linear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 176 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_linear_step2(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 376 ms per loop
</pre></div></div>
</div>
<p>Great!</p>
</div>
<div class="section" id="Step-3">
<h4>Step 3<a class="headerlink" href="#Step-3" title="Permalink to this headline">¶</a></h4>
<p>In this step, we get to introduce einstein summation to generalize the
calculations we perform across many dimensions in a more concise,
straightforward way. See <a class="reference external" href="https://rockt.github.io/2018/04/30/einsum">this blog
post</a> for some more
details on einstein summation notation. In short, it allows us to write</p>
<div class="math notranslate nohighlight">
\[c_j = \sum_i \sum_k = A_{ik} B_{kj} \qquad \rightarrow \qquad \texttt{einsum(&quot;ij,jk-&gt;i&quot;, A, B)}\]</div>
<p>in a much more elegant way to express many kinds of common tensor
operations such as dot products, transposes, outer products, and so on.
This step is generally the hardest as one needs to figure out the
corresponding <code class="docutils literal notranslate"><span class="pre">einsum</span></code> that keeps the calculation preserved (and
matching). To some extent it requires a lot of trial and error until you
get a feel for how einstein summation notation works.</p>
<p>As a concrete example of a conversion, we wish to go from something like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphaset</span><span class="p">:</span>
        <span class="n">deltas_up</span>    <span class="o">=</span> <span class="n">all_histo_deltas_up</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span>
        <span class="n">deltas_dn</span>    <span class="o">=</span> <span class="n">all_histo_deltas_dn</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span>
        <span class="n">calc_deltas</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deltas_up</span><span class="o">*</span><span class="n">alpha</span><span class="p">,</span> <span class="n">deltas_dn</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>to get rid of the loop over <code class="docutils literal notranslate"><span class="pre">alpha</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
    <span class="n">alphas_times_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,j-&gt;ij&#39;</span><span class="p">,</span><span class="n">alphaset</span><span class="p">,</span><span class="n">all_histo_deltas_up</span><span class="p">[</span><span class="n">nh</span><span class="p">])</span>
    <span class="n">alphas_times_deltas_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,j-&gt;ij&#39;</span><span class="p">,</span><span class="n">alphaset</span><span class="p">,</span><span class="n">all_histo_deltas_dn</span><span class="p">[</span><span class="n">nh</span><span class="p">])</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,j-&gt;ij&#39;</span><span class="p">,</span><span class="n">alphaset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">all_histo_deltas_dn</span><span class="p">[</span><span class="n">nh</span><span class="p">]))</span>

    <span class="n">alpha_deltas</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span><span class="n">alphas_times_deltas_up</span><span class="p">,</span> <span class="n">alphas_times_deltas_dn</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>In this particular case, we need an outer product that multiplies across
the <code class="docutils literal notranslate"><span class="pre">alphaset</span></code> to the corresponding <code class="docutils literal notranslate"><span class="pre">histoset</span></code> for the up/down
variations. Then we just need to select from either the up variation
calculation or the down variation calculation based on the sign of
alpha. Try to convince yourself that the einstein summation does what
the for-loop does, but a little bit more concisely, and perhaps more
clearly! How does the function look now?</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># remove the loop over alphas, starts using einsum to help generalize to more dimensions</span>
<span class="k">def</span> <span class="nf">new_interpolation_linear_step3</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>

    <span class="n">allset_all_histo_deltas_up</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">allset_all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">nset</span><span class="p">,(</span><span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">)):</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">all_histo_deltas_up</span> <span class="o">=</span> <span class="n">allset_all_histo_deltas_up</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>
        <span class="n">all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">allset_all_histo_deltas_dn</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
            <span class="n">alphas_times_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,j-&gt;ij&#39;</span><span class="p">,</span><span class="n">alphaset</span><span class="p">,</span><span class="n">all_histo_deltas_up</span><span class="p">[</span><span class="n">nh</span><span class="p">])</span>
            <span class="n">alphas_times_deltas_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,j-&gt;ij&#39;</span><span class="p">,</span><span class="n">alphaset</span><span class="p">,</span><span class="n">all_histo_deltas_dn</span><span class="p">[</span><span class="n">nh</span><span class="p">])</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,j-&gt;ij&#39;</span><span class="p">,</span><span class="n">alphaset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">all_histo_deltas_dn</span><span class="p">[</span><span class="n">nh</span><span class="p">]))</span>

            <span class="n">alpha_deltas</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span><span class="n">alphas_times_deltas_up</span><span class="p">,</span> <span class="n">alphas_times_deltas_dn</span><span class="p">)</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">alpha_deltas</span><span class="p">])</span>

        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>
</pre></div>
</div>
</div>
<p>And does the calculation still match?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_linear</span><span class="p">,</span> <span class="n">new_interpolation_linear_step3</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_linear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 176 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_linear_step3(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 786 ms per loop
</pre></div></div>
</div>
<p>Great! Note that we’ve been getting a little bit slower during these
steps. It will all pay off in the end when we’re fully tensorized! A lot
of the internal steps are overkill with the heavy einstein summation and
broadcasting at the moment, especially for how many loops in we are.</p>
</div>
<div class="section" id="Step-4">
<h4>Step 4<a class="headerlink" href="#Step-4" title="Permalink to this headline">¶</a></h4>
<p>Now in this step, we will move the einstein summations to the outer
loop, so that we’re calculating it once! This is the big step, but a
little bit easier because all we’re doing is adding extra dimensions
into the calculation. The underlying calculation won’t have changed. At
this point, we’ll also rename from <code class="docutils literal notranslate"><span class="pre">i</span></code> and <code class="docutils literal notranslate"><span class="pre">j</span></code> to <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>
for <code class="docutils literal notranslate"><span class="pre">alpha</span></code> and <code class="docutils literal notranslate"><span class="pre">bin</span></code> (as in the bin in the histogram). To continue
the notation as well, here’s a summary of the dimensions involved:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">s</span></code> will be for the set under consideration (e.g. the modifier)</li>
<li><code class="docutils literal notranslate"><span class="pre">a</span></code> will be for the alpha variation</li>
<li><code class="docutils literal notranslate"><span class="pre">h</span></code> will be for the histogram affected by the modifier</li>
<li><code class="docutils literal notranslate"><span class="pre">b</span></code> will be for the bin of the histogram</li>
</ul>
<p>So we wish to move the <code class="docutils literal notranslate"><span class="pre">einsum</span></code> code from</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">nset</span><span class="p">,(</span><span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">)):</span>
    <span class="o">...</span>

    <span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
        <span class="n">alphas_times_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,j-&gt;ij&#39;</span><span class="p">,</span><span class="n">alphaset</span><span class="p">,</span><span class="n">all_histo_deltas_up</span><span class="p">[</span><span class="n">nh</span><span class="p">])</span>
            <span class="o">...</span>
</pre></div>
</div>
<p>to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">all_alphas_times_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">,</span><span class="n">alphaset</span><span class="p">,</span><span class="n">all_histo_deltas_up</span><span class="p">)</span>
<span class="k">for</span> <span class="n">nset</span><span class="p">,(</span><span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">)):</span>
    <span class="o">...</span>

    <span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>So how does this new function look?</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [21]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># move the einsums to outer loops to get ready to get rid of all loops</span>
<span class="k">def</span> <span class="nf">new_interpolation_linear_step4</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">allset_all_histo_deltas_up</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">allset_all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">allset_all_histo_nom</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">allsets_all_histos_alphas_times_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span><span class="n">alphasets</span><span class="p">,</span><span class="n">allset_all_histo_deltas_up</span><span class="p">)</span>
    <span class="n">allsets_all_histos_alphas_times_deltas_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span><span class="n">alphasets</span><span class="p">,</span><span class="n">allset_all_histo_deltas_dn</span><span class="p">)</span>
    <span class="n">allsets_all_histos_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,s...u-&gt;s...au&#39;</span><span class="p">,</span><span class="n">alphasets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">allset_all_histo_deltas_dn</span><span class="p">))</span>

    <span class="n">allsets_all_histos_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">allsets_all_histos_masks</span><span class="p">,</span><span class="n">allsets_all_histos_alphas_times_deltas_up</span><span class="p">,</span> <span class="n">allsets_all_histos_alphas_times_deltas_dn</span><span class="p">)</span>

    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nset</span><span class="p">,</span><span class="n">histoset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">):</span>
        <span class="n">all_histos_deltas</span> <span class="o">=</span> <span class="n">allsets_all_histos_deltas</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span> <span class="o">+</span> <span class="n">histoset</span><span class="p">[</span><span class="n">nh</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_histos_deltas</span><span class="p">[</span><span class="n">nh</span><span class="p">]])</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>
</pre></div>
</div>
</div>
<p>And does the calculation still match?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [22]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_linear</span><span class="p">,</span> <span class="n">new_interpolation_linear_step4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [23]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_linear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 185 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [24]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_linear_step4(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
10 loops, best of 3: 131 ms per loop
</pre></div></div>
</div>
<p>Great! And look at that huge speed up in time already, just from moving
the multiple, heavy einstein summation calculations up through the
loops. We still have some more optimizing to do as we still have
explicit loops in our code. Let’s keep at it, we’re almost there!</p>
</div>
<div class="section" id="Step-5">
<h4>Step 5<a class="headerlink" href="#Step-5" title="Permalink to this headline">¶</a></h4>
<p>The hard part is mostly over. We have to now think about the nominal
variations. Recall that we were trying to add the nominals to the deltas
in order to compute the new value. In practice, we’ll return the delta
variation only, but we’ll show you how to get rid of this last loop. In
this case, we want to figure out how to change code like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">nset</span><span class="p">,</span><span class="n">histoset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">):</span>
    <span class="n">all_histos_deltas</span> <span class="o">=</span> <span class="n">allsets_all_histos_deltas</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>
    <span class="n">set_result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
        <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span> <span class="o">+</span> <span class="n">histoset</span><span class="p">[</span><span class="n">nh</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_histos_deltas</span><span class="p">[</span><span class="n">nh</span><span class="p">]])</span>
    <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_result</span><span class="p">)</span>
</pre></div>
</div>
<p>to get rid of that most-nested loop</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">nset</span><span class="p">,</span><span class="n">histoset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">):</span>
    <span class="c1"># look ma, no more loops inside!</span>
</pre></div>
</div>
<p>So how does this look?</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [25]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># slowly getting rid of our loops to build the right output tensor -- gotta think about nominals</span>
<span class="k">def</span> <span class="nf">new_interpolation_linear_step5</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">allset_all_histo_deltas_up</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">allset_all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">allset_all_histo_nom</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">allsets_all_histos_alphas_times_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span><span class="n">alphasets</span><span class="p">,</span><span class="n">allset_all_histo_deltas_up</span><span class="p">)</span>
    <span class="n">allsets_all_histos_alphas_times_deltas_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span><span class="n">alphasets</span><span class="p">,</span><span class="n">allset_all_histo_deltas_dn</span><span class="p">)</span>
    <span class="n">allsets_all_histos_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,s...u-&gt;s...au&#39;</span><span class="p">,</span><span class="n">alphasets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">allset_all_histo_deltas_dn</span><span class="p">))</span>

    <span class="n">allsets_all_histos_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">allsets_all_histos_masks</span><span class="p">,</span><span class="n">allsets_all_histos_alphas_times_deltas_up</span><span class="p">,</span> <span class="n">allsets_all_histos_alphas_times_deltas_dn</span><span class="p">)</span>

    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">nset</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">alphaset</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">)):</span>
        <span class="n">all_histos_deltas</span> <span class="o">=</span> <span class="n">allsets_all_histos_deltas</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>
        <span class="n">noms</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[</span><span class="n">nset</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">all_histos_noms_repeated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,hn-&gt;han&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">alphaset</span><span class="p">),</span><span class="n">noms</span><span class="p">)</span>

        <span class="n">set_result</span> <span class="o">=</span> <span class="n">all_histos_deltas</span> <span class="o">+</span> <span class="n">all_histos_noms_repeated</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>
</pre></div>
</div>
</div>
<p>And does the calculation still match?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [26]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_linear</span><span class="p">,</span> <span class="n">new_interpolation_linear_step5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [27]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_linear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 182 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [28]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_linear_step5(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1000 loops, best of 3: 1.66 ms per loop
</pre></div></div>
</div>
<p>Fantastic! And look at the speed up. We’re already faster than the
for-loop and we’re not even done yet.</p>
</div>
<div class="section" id="Step-6">
<h4>Step 6<a class="headerlink" href="#Step-6" title="Permalink to this headline">¶</a></h4>
<p>The final frontier. Also probably the best Star Wars episode. In any
case, we have one more for-loop that needs to die in a slab of
carbonite. This should be much easier now that you’re more comfortable
with tensor broadcasting and einstein summations.</p>
<p>What does the function look like now?</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [30]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">new_interpolation_linear_step6</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">allset_allhisto_deltas_up</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">allset_allhisto_deltas_dn</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">allset_allhisto_nom</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#x is dummy index</span>

    <span class="n">allsets_allhistos_alphas_times_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span><span class="n">alphasets</span><span class="p">,</span><span class="n">allset_allhisto_deltas_up</span><span class="p">)</span>
    <span class="n">allsets_allhistos_alphas_times_deltas_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span><span class="n">alphasets</span><span class="p">,</span><span class="n">allset_allhisto_deltas_dn</span><span class="p">)</span>
    <span class="n">allsets_allhistos_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,sxu-&gt;sxau&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alphasets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphasets</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">alphasets</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">allset_allhisto_deltas_dn</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="n">allsets_allhistos_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">allsets_allhistos_masks</span><span class="p">,</span><span class="n">allsets_allhistos_alphas_times_deltas_up</span><span class="p">,</span> <span class="n">allsets_allhistos_alphas_times_deltas_dn</span><span class="p">)</span>
    <span class="n">allsets_allhistos_noms_repeated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphasets</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="n">allset_allhisto_nom</span><span class="p">)</span>
    <span class="n">set_results</span> <span class="o">=</span> <span class="n">allsets_allhistos_deltas</span> <span class="o">+</span> <span class="n">allsets_allhistos_noms_repeated</span>
    <span class="k">return</span> <span class="n">set_results</span>
</pre></div>
</div>
</div>
<p>And does the calculation still match?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [31]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_linear</span><span class="p">,</span> <span class="n">new_interpolation_linear_step6</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [32]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_linear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 194 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [33]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_linear_step6(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1000 loops, best of 3: 435 µs per loop
</pre></div></div>
</div>
<p>And we’re done tensorizing it. There are some more improvements that
could be made to make this interpolation calculation even more robust –
but for now we’re done.</p>
</div>
</div>
<div class="section" id="Tensorizing-the-Non-Linear-Interpolator">
<h3>Tensorizing the Non-Linear Interpolator<a class="headerlink" href="#Tensorizing-the-Non-Linear-Interpolator" title="Permalink to this headline">¶</a></h3>
<p>This is very, very similar to what we’ve done for the case of the linear
interpolator. As such, we will provide the resulting functions for each
step, and you can see how things perform all the way at the bottom.
Enjoy and learn at your own pace!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [34]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">interpolation_nonlinear</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="n">all_results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">histo</span> <span class="ow">in</span> <span class="n">histoset</span><span class="p">:</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">histo_result</span> <span class="o">=</span> <span class="n">set_result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphaset</span><span class="p">:</span>
                <span class="n">alpha_result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">down</span><span class="p">,</span><span class="n">nom</span><span class="p">,</span><span class="n">up</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">histo</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">delta_up</span> <span class="o">=</span> <span class="n">up</span><span class="o">/</span><span class="n">nom</span>
                    <span class="n">delta_down</span> <span class="o">=</span> <span class="n">down</span><span class="o">/</span><span class="n">nom</span>
                    <span class="k">if</span> <span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span>  <span class="n">delta_up</span><span class="o">**</span><span class="n">alpha</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">delta</span> <span class="o">=</span>  <span class="n">delta_down</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">nom</span><span class="o">*</span><span class="n">delta</span>
                    <span class="n">alpha_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">histo_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>

<span class="k">def</span> <span class="nf">new_interpolation_nonlinear_step0</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="n">all_results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">histo</span> <span class="ow">in</span> <span class="n">histoset</span><span class="p">:</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">histo_result</span> <span class="o">=</span> <span class="n">set_result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphaset</span><span class="p">:</span>
                <span class="n">alpha_result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">down</span><span class="p">,</span><span class="n">nom</span><span class="p">,</span><span class="n">up</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">histo</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">delta_up</span> <span class="o">=</span> <span class="n">up</span><span class="o">/</span><span class="n">nom</span>
                    <span class="n">delta_down</span> <span class="o">=</span> <span class="n">down</span><span class="o">/</span><span class="n">nom</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">delta_up</span><span class="p">,</span> <span class="n">alpha</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">delta_down</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="p">)))</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">nom</span><span class="o">*</span><span class="n">delta</span>
                    <span class="n">alpha_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">histo_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>

<span class="k">def</span> <span class="nf">new_interpolation_nonlinear_step1</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="n">all_results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">histo</span> <span class="ow">in</span> <span class="n">histoset</span><span class="p">:</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">histo_result</span> <span class="o">=</span> <span class="n">set_result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphaset</span><span class="p">:</span>
                <span class="n">alpha_result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">deltas_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deltas_up</span><span class="p">,</span> <span class="n">deltas_down</span><span class="p">)</span>
                <span class="n">exponents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
                <span class="n">calc_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">exponents</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">calc_deltas</span>
                <span class="n">alpha_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">histo_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>

<span class="k">def</span> <span class="nf">new_interpolation_nonlinear_step2</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>

    <span class="n">allset_all_histo_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">allset_all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">nset</span><span class="p">,(</span><span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">)):</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">all_histo_deltas_up</span> <span class="o">=</span> <span class="n">allset_all_histo_deltas_up</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>
        <span class="n">all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">allset_all_histo_deltas_dn</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
            <span class="n">alpha_deltas</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphaset</span><span class="p">:</span>
                <span class="n">alpha_result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">deltas_up</span> <span class="o">=</span> <span class="n">all_histo_deltas_up</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span>
                <span class="n">deltas_down</span> <span class="o">=</span> <span class="n">all_histo_deltas_dn</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span>
                <span class="n">bases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deltas_up</span><span class="p">,</span> <span class="n">deltas_down</span><span class="p">)</span>
                <span class="n">exponents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
                <span class="n">calc_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">exponents</span><span class="p">)</span>
                <span class="n">alpha_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_deltas</span><span class="p">)</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">alpha_deltas</span><span class="p">])</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>

<span class="k">def</span> <span class="nf">new_interpolation_nonlinear_step3</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>

    <span class="n">allset_all_histo_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">allset_all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">nset</span><span class="p">,(</span><span class="n">histoset</span><span class="p">,</span> <span class="n">alphaset</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">)):</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">all_histo_deltas_up</span> <span class="o">=</span> <span class="n">allset_all_histo_deltas_up</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>
        <span class="n">all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">allset_all_histo_deltas_dn</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
            <span class="c1"># bases and exponents need to have an outer product, to esentially tile or repeat over rows/cols</span>
            <span class="n">bases_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,b-&gt;ab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphaset</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">all_histo_deltas_up</span><span class="p">[</span><span class="n">nh</span><span class="p">])</span>
            <span class="n">bases_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,b-&gt;ab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphaset</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">all_histo_deltas_dn</span><span class="p">[</span><span class="n">nh</span><span class="p">])</span>
            <span class="n">exponents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,b-&gt;ab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alphaset</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">all_histo_deltas_up</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

            <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,b-&gt;ab&#39;</span><span class="p">,</span><span class="n">alphaset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">all_histo_deltas_dn</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">bases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">bases_up</span><span class="p">,</span> <span class="n">bases_dn</span><span class="p">)</span>
            <span class="n">alpha_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">exponents</span><span class="p">)</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">histo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">alpha_deltas</span><span class="p">])</span>

        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>

<span class="k">def</span> <span class="nf">new_interpolation_nonlinear_step4</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>

    <span class="n">allset_all_histo_nom</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">allset_all_histo_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">allset_all_histo_nom</span><span class="p">)</span>
    <span class="n">allset_all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">allset_all_histo_nom</span><span class="p">)</span>

    <span class="n">bases_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphasets</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">allset_all_histo_deltas_up</span><span class="p">)</span>
    <span class="n">bases_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphasets</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">allset_all_histo_deltas_dn</span><span class="p">)</span>
    <span class="n">exponents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alphasets</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">allset_all_histo_deltas_up</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span><span class="n">alphasets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">allset_all_histo_deltas_up</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">bases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">bases_up</span><span class="p">,</span> <span class="n">bases_dn</span><span class="p">)</span>

    <span class="n">allsets_all_histos_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">exponents</span><span class="p">)</span>

    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nset</span><span class="p">,</span><span class="n">histoset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">):</span>
        <span class="n">all_histos_deltas</span> <span class="o">=</span> <span class="n">allsets_all_histos_deltas</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nh</span><span class="p">,</span><span class="n">histo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histoset</span><span class="p">):</span>
            <span class="n">set_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">histoset</span><span class="p">[</span><span class="n">nh</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_histos_deltas</span><span class="p">[</span><span class="n">nh</span><span class="p">]])</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>

<span class="k">def</span> <span class="nf">new_interpolation_nonlinear_step5</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>

    <span class="n">allset_all_histo_nom</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">allset_all_histo_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">allset_all_histo_nom</span><span class="p">)</span>
    <span class="n">allset_all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">allset_all_histo_nom</span><span class="p">)</span>

    <span class="n">bases_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphasets</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">allset_all_histo_deltas_up</span><span class="p">)</span>
    <span class="n">bases_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphasets</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">allset_all_histo_deltas_dn</span><span class="p">)</span>
    <span class="n">exponents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alphasets</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">allset_all_histo_deltas_up</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span><span class="n">alphasets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">allset_all_histo_deltas_up</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">bases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">bases_up</span><span class="p">,</span> <span class="n">bases_dn</span><span class="p">)</span>

    <span class="n">allsets_all_histos_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">exponents</span><span class="p">)</span>

    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nset</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">alphaset</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">)):</span>
        <span class="n">all_histos_deltas</span> <span class="o">=</span> <span class="n">allsets_all_histos_deltas</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>
        <span class="n">noms</span> <span class="o">=</span> <span class="n">allset_all_histo_nom</span><span class="p">[</span><span class="n">nset</span><span class="p">]</span>
        <span class="n">all_histos_noms_repeated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,hn-&gt;han&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">alphaset</span><span class="p">),</span><span class="n">noms</span><span class="p">)</span>
        <span class="n">set_result</span> <span class="o">=</span> <span class="n">all_histos_deltas</span> <span class="o">*</span> <span class="n">all_histos_noms_repeated</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_results</span>

<span class="k">def</span> <span class="nf">new_interpolation_nonlinear_step6</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">,</span><span class="n">alphasets</span><span class="p">):</span>
    <span class="n">all_results</span>    <span class="o">=</span> <span class="p">[]</span>

    <span class="n">allset_all_histo_nom</span> <span class="o">=</span> <span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">allset_all_histo_deltas_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">allset_all_histo_nom</span><span class="p">)</span>
    <span class="n">allset_all_histo_deltas_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">histogramssets</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">allset_all_histo_nom</span><span class="p">)</span>

    <span class="n">bases_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphasets</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">allset_all_histo_deltas_up</span><span class="p">)</span>
    <span class="n">bases_dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphasets</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">allset_all_histo_deltas_dn</span><span class="p">)</span>
    <span class="n">exponents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alphasets</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">allset_all_histo_deltas_up</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span><span class="n">alphasets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">allset_all_histo_deltas_up</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">bases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">bases_up</span><span class="p">,</span> <span class="n">bases_dn</span><span class="p">)</span>

    <span class="n">allsets_all_histos_deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">exponents</span><span class="p">)</span>
    <span class="n">allsets_allhistos_noms_repeated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sa,shb-&gt;shab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">alphasets</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">allset_all_histo_nom</span><span class="p">)</span>
    <span class="n">set_results</span> <span class="o">=</span> <span class="n">allsets_all_histos_deltas</span> <span class="o">*</span> <span class="n">allsets_allhistos_noms_repeated</span>
    <span class="k">return</span> <span class="n">set_results</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [35]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_nonlinear</span><span class="p">,</span> <span class="n">new_interpolation_nonlinear_step0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [36]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_nonlinear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 182 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [37]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_nonlinear_step0(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 593 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [38]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_nonlinear</span><span class="p">,</span> <span class="n">new_interpolation_nonlinear_step1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [39]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_nonlinear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 185 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [40]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_nonlinear_step1(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 545 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [41]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_nonlinear</span><span class="p">,</span> <span class="n">new_interpolation_nonlinear_step2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [42]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_nonlinear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 177 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [43]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_nonlinear_step2(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 446 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [44]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_nonlinear</span><span class="p">,</span> <span class="n">new_interpolation_nonlinear_step3</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [45]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_nonlinear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
10 loops, best of 3: 181 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [46]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_nonlinear_step3(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 1.27 s per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [47]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_nonlinear</span><span class="p">,</span> <span class="n">new_interpolation_nonlinear_step4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [48]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_nonlinear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 loop, best of 3: 167 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [49]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_nonlinear_step4(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
10 loops, best of 3: 128 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [50]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_nonlinear</span><span class="p">,</span> <span class="n">new_interpolation_nonlinear_step5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [51]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_nonlinear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
10 loops, best of 3: 171 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [52]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_nonlinear_step5(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
100 loops, best of 3: 2.47 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [53]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="n">compare_fns</span><span class="p">(</span><span class="n">interpolation_nonlinear</span><span class="p">,</span> <span class="n">new_interpolation_nonlinear_step6</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [54]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
interpolation_nonlinear(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
10 loops, best of 3: 192 ms per loop
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [55]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">timeit</span>
new_interpolation_nonlinear_step6(h,a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1000 loops, best of 3: 1.51 ms per loop
</pre></div></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Lukas Heinrich, Matthew Feickert, Giordon Stark.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.0.4',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>